@{
    ViewBag.Title = "Home Page";
}

<style>
    .modal {
        min-height: 500px;
        min-width: 1000px;
    }

    .county {
        border: 1px solid #0073e6;
        margin: 2px;
    }

    .countySelected {
        background-color: #979899;
    }

    .notSelected {
        background-color: transparent;
    }
</style>
<button id="btnOpenScheduler">Open Scheduler</button>

<div id="schModal" class="modal container-fluid">
    <!-- Modal content-->
    <div id="counties" class="row">
    </div>
    <div class="row">
        <div class="col-sm-2">
            <select id="selectedStaff1" class="multiple-select selections" name="states[]" multiple="multiple"></select>
        </div>

        <div class="col-sm-2">
            <select id="selectedStaff2" class="multiple-select selections" name="states[]" multiple="multiple"></select>
        </div>

        <div class="col-sm-2">
            <select id="selectedStaff3" class="multiple-select selections" name="states[]" multiple="multiple"></select>
        </div>
    </div>
    <div class="row">
        <button id="submit">Submit Data</button>
    </div>
</div>


<script>
    var masterData = undefined;
    var previous_selected_condition_id = undefined;
    var previous_selected_condition_element = undefined;
    function updateStaffSelection(condition_id) {
        $("[county-id=" + condition_id + "]").data({
            OncallConditionId: condition_id,
            SelectedFirst: $("#selectedStaff1").val(),
            SelectedSecond: $("#selectedStaff2").val(),
            SelectedThird: $("#selectedStaff3").val()
        });

    }
    function loadSelection(condition_id) {
        var data = $("[county-id=" + condition_id + "]").data()
        if (data !== undefined && data !== null) {
            $("#selectedStaff1").val(data.SelectedFirst);
            $("#selectedStaff2").val(data.SelectedSecond);
            $("#selectedStaff3").val(data.SelectedThird);

        }
        else {
            $('.selections').each(function (i, elem) {
                $(elem).val(Array.empty);
            });
        }

        $('.selections').trigger('change');

    }

    $('#btnOpenScheduler').click(function () {
        previous_selected_condition_id = undefined;
        previous_selected_condition_element = undefined;
        $("#schModal").modal();
        loadCounties();


    });

    $("#submit").click(submitForm);

    function loadCounties() {
        $.ajax({
            url: "http://localhost:51247/api/GetCounties",
            success: function (result) {
                if (result.result) {
                    masterData = result.result;
                }
                addStaff();
                addCounties();

            }
        });
    }

    function addCounties() {
        if (masterData !== undefined) {
            $('#counties').empty();
            var condition_id_to_select = undefined;
            var selectedclass = "";
            var selectedprop = "false";
            for (var i = 0; i < masterData.Counties.length; i++) {

                if (condition_id_to_select != undefined && condition_id_to_select == masterData.Counties[i].ID) {
                    selectedclass = "col-md-2 county countySelected";
                    selectedprop = "true";
                    loadSelection(condition_id_to_select);
                    previous_selected_condition_id = condition_id_to_select;
                }
                else {
                    selectedclass = "col-md-2 county";
                }
                $('#counties').append('<div id="conditionid-' + masterData.Counties[i].ID + '" class="' + selectedclass + '" county-id="' + masterData.Counties[i].ID + '"selected=' + selectedprop + ' onClick = "CountySelection(this)" > ' + masterData.Counties[i].Name + '</div > ');

                if (condition_id_to_select != undefined && condition_id_to_select == masterData.Counties[i].ID) {
                    previous_selected_condition_element = $('#conditionid-' + masterData.Counties[i].ID);
                }


            }

        }
    }

    function CountySelection(elem) {
        var currentValue = $(elem).prop("selected");
        if (currentValue === 'true') {
            $(elem).prop("selected", 'false');
            $(elem).removeClass("countySelected").addClass("notSelected");

        } else {
            $(elem).prop("selected", 'true');
            $(elem).removeClass("notSelected").addClass("countySelected");
            if (previous_selected_condition_element != undefined) {
                previous_selected_condition_element.prop("selected", 'false');
                previous_selected_condition_element.removeClass("countySelected").addClass("notSelected");
            }
            previous_selected_condition_element = $(elem);
            updateStaffSelection(previous_selected_condition_id);
            loadSelection($(elem).attr("county-id"));
            previous_selected_condition_id = $(elem).attr("county-id");
        }
    }

    function addStaff() {
        if (masterData !== undefined) {
            var Data = [];
            for (var i = 0; i < masterData.StaffMembers.length; i++) {
                Data.push({ id: masterData.StaffMembers[i].ID, text: masterData.StaffMembers[i].Name });
            }
            $(".multiple-select").select2({
                data: Data
            });
        }
    }

    function submitForm() {
        var lastCounty = $('.countySelected').attr("county-id");
        updateStaffSelection(lastCounty);
        var submitData = { OncallConditionalStaffs: [] };
        $('.county').each(function (i, elem){
            var data = $(elem).data();
            if (data !== null && data !== undefined) {
                if (data.OncallConditionId !== undefined) {
                    submitData.OncallConditionalStaffs.push(data);
                }
            }
        });
        $.ajax({
            type: "POST",
            url: "http://localhost:51247/api/SubmitSchedule",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            data: JSON.stringify(submitData),
            success: function (result) {
                if (result) {
                    alert('data saved');
                }
            },
            error: function () {
                alert("error");
            }
        });
    }

</script>